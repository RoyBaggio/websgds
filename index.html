<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Bank Sampah Makanan ‚Äì SDGs 2 & 12</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        /* ====== RESET SEDERHANA ====== */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        }

        body {
            background: #f4f6fb;
            color: #222;
            line-height: 1.6;
        }

        a {
            color: #2563eb;
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        /* ====== LAYOUT DASAR ====== */
        header {
            position: sticky;
            top: 0;
            z-index: 50;
            background: #ffffffcc;
            backdrop-filter: blur(12px);
            border-bottom: 1px solid #e5e7eb;
        }

        .nav {
            max-width: 1100px;
            margin: 0 auto;
            padding: 0.7rem 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo {
            font-weight: 700;
            font-size: 1.1rem;
            color: #16a34a;
        }

        .logo span {
            color: #2563eb;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
        }

        .nav-links a {
            padding: 0.3rem 0.6rem;
            border-radius: 999px;
        }

        .nav-links a:hover {
            background: #e5f0ff;
        }

        main {
            max-width: 1100px;
            margin: 0 auto;
            padding: 1.5rem 1rem 3rem;
        }

        section {
            margin-bottom: 3rem;
        }

        h1, h2, h3 {
            font-weight: 700;
            color: #111827;
        }

        h2 {
            margin-bottom: 0.75rem;
        }

        p {
            margin-bottom: 0.6rem;
            font-size: 0.95rem;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            font-size: 0.75rem;
            padding: 0.2rem 0.6rem;
            border-radius: 999px;
            background: #e5f0ff;
            color: #1d4ed8;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 1.5rem;
        }

        @media (max-width: 768px) {
            .grid {
                grid-template-columns: 1fr;
            }

            .nav-links {
                display: none;
            }
        }

        .card {
            background: #ffffff;
            border-radius: 0.75rem;
            padding: 1rem 1.2rem;
            box-shadow: 0 8px 24px rgba(15, 23, 42, 0.06);
            border: 1px solid #e5e7eb;
        }

        .card-header {
            display: flex;
            align-items: baseline;
            justify-content: space-between;
            margin-bottom: 0.6rem;
        }

        .pill {
            display: inline-block;
            padding: 0.1rem 0.5rem;
            border-radius: 999px;
            font-size: 0.7rem;
            background: #f1f5f9;
            color: #64748b;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            padding: 0.5rem 0.9rem;
            border-radius: 999px;
            border: none;
            background: #16a34a;
            color: white;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .btn.secondary {
            background: #2563eb;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn:hover:not(:disabled) {
            filter: brightness(0.96);
        }

        .hero {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1.4fr);
            gap: 1.5rem;
            align-items: center;
            margin-bottom: 2.5rem;
        }

        @media (max-width: 900px) {
            .hero {
                grid-template-columns: 1fr;
            }
        }

        .hero-title {
            font-size: clamp(1.7rem, 3vw, 2.2rem);
            margin-bottom: 0.75rem;
        }

        .hero-subtitle {
            font-size: 0.95rem;
            color: #4b5563;
            margin-bottom: 1rem;
        }

        .hero-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1.3rem;
        }

        .hero-actions {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-bottom: 0.75rem;
        }

        .hero-note {
            font-size: 0.8rem;
            color: #6b7280;
        }

        .hero-visual {
            background: radial-gradient(circle at top left, #bbf7d0, #eff6ff);
            border-radius: 1rem;
            padding: 1.2rem;
            display: grid;
            gap: 0.8rem;
        }

        .hero-visual-item {
            background: #ffffffcc;
            backdrop-filter: blur(8px);
            padding: 0.6rem 0.8rem;
            border-radius: 0.8rem;
            font-size: 0.8rem;
            border: 1px solid #e5e7eb;
        }

        .hero-visual-item strong {
            display: block;
        }

        /* ====== ARTIKEL ====== */
        .articles {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 1rem;
        }

        @media (max-width: 900px) {
            .articles {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 640px) {
            .articles {
                grid-template-columns: 1fr;
            }
        }

        .article-card h3 {
            font-size: 0.95rem;
            margin-bottom: 0.4rem;
        }

        .article-meta {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 0.4rem;
        }

        /* ====== FORM / INPUT ====== */
        label {
            font-size: 0.8rem;
            font-weight: 600;
            display: block;
            margin-bottom: 0.2rem;
        }

        input, select, textarea {
            width: 100%;
            padding: 0.45rem 0.6rem;
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            font-size: 0.85rem;
            margin-bottom: 0.6rem;
            outline: none;
        }

        input:focus, select:focus, textarea:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 1px #93c5fd;
        }

        .result-box {
            margin-top: 0.4rem;
            padding: 0.6rem 0.75rem;
            border-radius: 0.6rem;
            background: #f1f5f9;
            font-size: 0.85rem;
        }

        .result-highlight {
            font-weight: 700;
            color: #16a34a;
        }

        /* ====== CHAT / SCANNER / VISION ====== */
        .chat-box {
            max-height: 260px;
            overflow-y: auto;
            padding: 0.6rem;
            background: #f9fafb;
            border-radius: 0.6rem;
            border: 1px solid #e5e7eb;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }

        .chat-msg {
            margin-bottom: 0.4rem;
            display: flex;
        }

        .chat-msg.user {
            justify-content: flex-end;
        }

        .chat-bubble {
            max-width: 80%;
            padding: 0.4rem 0.6rem;
            border-radius: 0.7rem;
        }

        .chat-msg.user .chat-bubble {
            background: #2563eb;
            color: white;
            border-bottom-right-radius: 0.1rem;
        }

        .chat-msg.bot .chat-bubble {
            background: #e5f0ff;
            color: #111827;
            border-bottom-left-radius: 0.1rem;
        }

        .ai-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.75rem;
            padding: 0.1rem 0.5rem;
            border-radius: 999px;
            background: #fef3c7;
            color: #92400e;
            margin-bottom: 0.4rem;
        }

        .scanner-layout {
            display: grid;
            grid-template-columns: minmax(0, 1.2fr) minmax(0, 1.2fr) minmax(0, 1.2fr);
            gap: 1rem;
        }

        @media (max-width: 1100px) {
            .scanner-layout {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
        }

        @media (max-width: 800px) {
            .scanner-layout {
                grid-template-columns: 1fr;
            }
        }

        #visionPreview {
            max-width: 100%;
            border-radius: 0.5rem;
            margin-bottom: 0.4rem;
            display: none;
        }

        footer {
            border-top: 1px solid #e5e7eb;
            padding: 1rem;
            text-align: center;
            font-size: 0.8rem;
            color: #6b7280;
        }
    </style>
</head>
<body>

<header>
    <nav class="nav">
        <div class="logo">BankSampah<span>Makanan</span></div>
        <div class="nav-links">
            <a href="#tentang">Tentang</a>
            <a href="#artikel">Artikel</a>
            <a href="#bmi">BMI & Kalori</a>
            <a href="#ai">AI & Scanner</a>
        </div>
    </nav>
</header>

<main>
    <!-- ====== HERO / BERANDA ====== -->
    <section class="hero">
        <div>
            <div class="tag">
                üåç SDGs 2 & 12
                <span>Zero Hunger ¬∑ Responsible Consumption</span>
            </div>

            <h1 class="hero-title">
                Kurangi Sampah Makanan, Jaga Bumi, Jaga Piringmu.
            </h1>

            <p class="hero-subtitle">
                Website edukasi bank sampah makanan yang membantu kamu mengelola sisa makanan,
                menghitung kebutuhan kalori harian, dan mengenali jenis sampah makanan dengan bantuan AI.
            </p>

            <div class="hero-badges">
                <span class="pill">SDG 2: Zero Hunger</span>
                <span class="pill">SDG 12: Responsible Consumption</span>
                <span class="pill">Food Waste Awareness</span>
            </div>

            <div class="hero-actions">
                <a href="#bmi">
                    <button class="btn">Hitung BMI & Kalori</button>
                </a>
                <a href="#ai">
                    <button class="btn secondary">Coba AI & Scanner</button>
                </a>
            </div>

            <p class="hero-note">
                Dengan tahu kebutuhan kalori harian, kita bisa makan secukupnya dan mengurangi makanan yang terbuang.  
                Sisa makanan yang masih layak bisa diolah, bukan langsung jadi sampah.
            </p>
        </div>

        <div class="hero-visual">
            <div class="hero-visual-item">
                <strong>üéØ Tujuan</strong>
                Mengedukasi masyarakat agar lebih bijak mengonsumsi makanan, mengurangi food waste,
                dan mendukung pencapaian SDGs 2 & 12.
            </div>
            <div class="hero-visual-item">
                <strong>‚ôªÔ∏è Konsep Bank Sampah Makanan</strong>
                Sisa makanan dapat diolah menjadi kompos, pakan ternak, atau dioptimalkan kembali,
                bukan hanya berakhir di tempat pembuangan akhir.
            </div>
            <div class="hero-visual-item">
                <strong>ü§ñ Bantuan AI</strong>
                AI membantu mengenali jenis sampah makanan dan memberi estimasi kalori makanan yang ‚Äúterbuang‚Äù.
            </div>
        </div>
    </section>

    <!-- ====== TENTANG / SDGS ====== -->
    <section id="tentang">
        <h2>Tentang Bank Sampah Makanan & SDGs</h2>
        <p>
            <strong>Bank sampah makanan</strong> adalah konsep pengelolaan sisa makanan agar tidak langsung menjadi sampah
            yang mencemari lingkungan. Sisa makanan dapat:
        </p>
        <ul style="margin-bottom: 0.6rem; padding-left: 1.2rem; font-size: 0.9rem;">
            <li>Didistribusikan ulang jika masih layak konsumsi (misalnya ke komunitas yang membutuhkan).</li>
            <li>Diolah menjadi kompos untuk pertanian atau urban farming.</li>
            <li>Dimanfaatkan sebagai pakan ternak.</li>
        </ul>
        <p>
            Konsep ini mendukung:
        </p>
        <ul style="padding-left: 1.2rem; font-size: 0.9rem;">
            <li><strong>SDGs 2 ‚Äì Zero Hunger:</strong> mengurangi kelaparan dengan mengoptimalkan makanan yang tersedia.</li>
            <li><strong>SDGs 12 ‚Äì Responsible Consumption and Production:</strong> mendorong pola konsumsi yang bertanggung jawab,
                mengurangi pemborosan, dan mengelola sampah makanan dengan lebih bijak.</li>
        </ul>
    </section>

    <!-- ====== ARTIKEL ====== -->
    <section id="artikel">
        <div style="display: flex; align-items: baseline; justify-content: space-between; gap: 1rem; margin-bottom: 0.8rem;">
            <h2>Artikel Edukasi Pengelolaan Sampah Makanan</h2>
            <span class="pill">Sumber: diringkas dari berbagai artikel</span>
        </div>
        <p style="margin-bottom: 1rem;">
            Berikut beberapa topik yang bisa kamu pelajari untuk mulai mengurangi sampah makanan.
            Teks di bawah ini bisa kamu ganti dan lengkapi berdasarkan referensi artikel yang kamu gunakan dalam laporan.
        </p>

        <div class="articles">
            <article class="card article-card">
                <h3>Mengurangi Food Waste di Rumah Tangga</h3>
                <p class="article-meta">Perencanaan belanja ¬∑ Penyimpanan bahan ¬∑ Manajemen stok</p>
                <p>
                    Mulai dari membuat daftar belanja, menyimpan bahan makanan dengan benar, hingga mengolah sisa makanan
                    menjadi menu baru, semua berkontribusi mengurangi sampah makanan.
                </p>
                <a href="#" onclick="alert('Ganti # dengan link referensi artikel aslimu.'); return false;">Baca sumber &raquo;</a>
            </article>

            <article class="card article-card">
                <h3>Mengenal Kompos dari Sisa Makanan</h3>
                <p class="article-meta">Kompos ¬∑ Organik ¬∑ Urban farming</p>
                <p>
                    Sisa sayur, buah, dan beberapa jenis makanan dapat diolah menjadi kompos yang bermanfaat untuk tanaman,
                    mengurangi timbunan sampah organik di TPA.
                </p>
                <a href="#" onclick="alert('Ganti # dengan link referensi artikel aslimu.'); return false;">Baca sumber &raquo;</a>
            </article>

            <article class="card article-card">
                <h3>Food Sharing & Donasi Makanan</h3>
                <p class="article-meta">Berbagi makanan ¬∑ Komunitas ¬∑ SDG 2</p>
                <p>
                    Makanan berlebih yang masih layak konsumsi dapat didistribusikan ke komunitas yang membutuhkan,
                    membantu mengurangi kelaparan sekaligus mengurangi food waste.
                </p>
                <a href="#" onclick="alert('Ganti # dengan link referensi artikel aslimu.'); return false;">Baca sumber &raquo;</a>
            </article>
        </div>
    </section>

    <!-- ====== BMI & KALORI ====== -->
    <section id="bmi">
        <div class="grid">
            <!-- Kalkulator -->
            <div class="card">
                <div class="card-header">
                    <h2>Kalkulator BMI & Kebutuhan Kalori</h2>
                    <span class="pill">Cek secukupnya, makan secukupnya</span>
                </div>
                <p style="margin-bottom: 0.7rem; font-size: 0.9rem;">
                    Dengan mengetahui status BMI dan kebutuhan kalori harian, kita bisa mengatur porsi makan
                    agar lebih seimbang. Secara tidak langsung, ini membantu mengurangi pemborosan makanan.
                </p>

                <form id="bmiForm" onsubmit="event.preventDefault(); hitungBMIKalori();">
                    <label for="gender">Jenis Kelamin</label>
                    <select id="gender" required>
                        <option value="">Pilih...</option>
                        <option value="male">Laki-laki</option>
                        <option value="female">Perempuan</option>
                    </select>

                    <label for="age">Usia (tahun)</label>
                    <input type="number" id="age" min="10" max="100" required placeholder="Contoh: 20">

                    <label for="height">Tinggi badan (cm)</label>
                    <input type="number" id="height" min="120" max="220" required placeholder="Contoh: 165">

                    <label for="weight">Berat badan (kg)</label>
                    <input type="number" id="weight" min="30" max="200" step="0.1" required placeholder="Contoh: 60">

                    <label for="activity">Level aktivitas</label>
                    <select id="activity" required>
                        <option value="">Pilih...</option>
                        <option value="1.2">Ringan (banyak duduk)</option>
                        <option value="1.375">Sedang (1‚Äì3x olahraga/minggu)</option>
                        <option value="1.55">Cukup aktif (3‚Äì5x olahraga/minggu)</option>
                        <option value="1.725">Sangat aktif (6‚Äì7x olahraga/minggu)</option>
                    </select>

                    <button type="submit" class="btn" style="margin-top: 0.3rem;">Hitung</button>
                </form>

                <div id="bmiResult" class="result-box" style="display:none;"></div>
            </div>

            <!-- Edukasi -->
            <div class="card">
                <h3>Kenapa fitur ini mendukung pengurangan sampah makanan?</h3>
                <p>
                    Salah satu penyebab food waste adalah kebiasaan makan berlebihan: porsi terlalu banyak,
                    lapar mata saat belanja, atau membeli makanan tanpa mempertimbangkan kebutuhan tubuh.
                </p>
                <p>
                    Dengan tahu kebutuhan kalori harian:
                </p>
                <ul style="padding-left: 1.2rem; font-size: 0.9rem;">
                    <li>Kita bisa mengatur porsi makan lebih realistis.</li>
                    <li>Mengurangi kebiasaan membeli makanan berlebih yang ujung-ujungnya terbuang.</li>
                    <li>Mendukung pola hidup sehat sekaligus ramah lingkungan.</li>
                </ul>
                <p style="margin-top: 0.6rem; font-size: 0.85rem; color: #6b7280;">
                    *Perhitungan di atas hanya estimasi sederhana berdasarkan rumus Mifflin-St Jeor.
                    Konsultasi ke tenaga kesehatan tetap disarankan untuk rekomendasi yang lebih akurat.
                </p>
            </div>
        </div>
    </section>

    <!-- ====== AI & SCANNER & VISION ====== -->
    <section id="ai">
        <div class="scanner-layout">
            <!-- Chat AI -->
            <div class="card">
                <div class="card-header">
                    <h2>Asisten AI Sampah Makanan</h2>
                    <span class="pill">Terhubung ke Gemini (via backend)</span>
                </div>
                <p style="font-size: 0.9rem; margin-bottom: 0.5rem;">
                    Tanyakan apa saja tentang pengelolaan sampah makanan, food waste, dan kaitannya dengan SDGs 2 & 12.
                    Jawaban dihasilkan oleh model AI di server.
                </p>
                <div class="ai-badge">
                    ü§ñ AI Chat ¬∑ Edukasi sampah makanan
                </div>

                <div id="chatBox" class="chat-box"></div>

                <form id="chatForm" onsubmit="event.preventDefault(); kirimPesanAI();">
                    <label for="chatInput">Tanya sesuatu:</label>
                    <input id="chatInput" type="text" placeholder="Contoh: Gimana cara mengolah sisa nasi semalam?" required>
                    <button type="submit" class="btn secondary" style="margin-top: 0.1rem;">Kirim</button>
                </form>
            </div>

            <!-- Scanner manual -->
            <div class="card">
                <div class="card-header">
                    <h2>‚ÄúScanner‚Äù Makanan & Estimasi Kalori</h2>
                    <span class="pill">Input teks manual</span>
                </div>
                <p style="font-size: 0.9rem; margin-bottom: 0.6rem;">
                    Masukkan nama makanan dan perkiraan beratnya. Sistem akan menghitung estimasi kalori berdasarkan database sederhana,
                    dan menentukan jenis sampah (organik/anorganik).
                </p>

                <form id="scannerForm" onsubmit="event.preventDefault(); scanMakanan();">
                    <label for="foodName">Nama makanan</label>
                    <input id="foodName" type="text" placeholder="Contoh: nasi, ayam goreng, sayur tumis, plastik, dll" required>

                    <label for="foodWeight">Perkiraan berat (gram)</label>
                    <input id="foodWeight" type="number" min="1" max="2000" placeholder="Contoh: 150" required>

                    <button type="submit" class="btn" style="margin-top: 0.1rem;">Deteksi Jenis & Kalori</button>
                </form>

                <div id="scannerResult" class="result-box" style="display:none;"></div>
            </div>

            <!-- AI Vision -->
            <div class="card">
                <div class="card-header">
                    <h2>AI Vision ‚Äì Foto Makanan</h2>
                    <span class="pill">Analisis gambar via backend</span>
                </div>
                <p style="font-size: 0.9rem; margin-bottom: 0.6rem;">
                    Upload foto makananmu. AI akan mencoba mengenali makanan, memperkirakan kalori, dan memberi saran
                    pengurangan food waste. Pemrosesan dilakukan di server, API key disimpan aman.
                </p>

                <img id="visionPreview" alt="Preview foto makanan">

                <form id="visionForm" onsubmit="event.preventDefault(); handleVisionUpload();">
                    <label for="foodImage">Pilih foto makanan (jpg/png)</label>
                    <input id="foodImage" type="file" accept="image/*" required>

                    <button type="submit" class="btn" style="margin-top: 0.2rem;">
                        Kirim ke AI Vision
                    </button>
                </form>

                <div id="visionResult" class="result-box" style="display:none; margin-top:0.6rem;"></div>
            </div>
        </div>
    </section>
</main>

<footer>
    Bank Sampah Makanan ¬∑ Prototype tugas website SDGs 2 & 12 ¬∑ Dibuat untuk edukasi pengurangan sampah makanan.
</footer>

<script>
    // =======================
    // 1. KALKULATOR BMI & KALORI
    // =======================
    function hitungBMIKalori() {
        const gender = document.getElementById('gender').value;
        const age = parseInt(document.getElementById('age').value);
        const heightCm = parseFloat(document.getElementById('height').value);
        const weightKg = parseFloat(document.getElementById('weight').value);
        const activity = parseFloat(document.getElementById('activity').value);
        const resultBox = document.getElementById('bmiResult');

        if (!gender || !age || !heightCm || !weightKg || !activity) {
            alert('Lengkapi semua data dulu ya.');
            return;
        }

        const heightM = heightCm / 100;
        const bmi = weightKg / (heightM * heightM);

        let kategori = '';
        if (bmi < 18.5) kategori = 'Kurus';
        else if (bmi < 23) kategori = 'Normal';
        else if (bmi < 27.5) kategori = 'Kelebihan berat badan';
        else kategori = 'Obesitas';

        // Rumus Mifflin-St Jeor
        let bmr;
        if (gender === 'male') {
            bmr = 10 * weightKg + 6.25 * heightCm - 5 * age + 5;
        } else {
            bmr = 10 * weightKg + 6.25 * heightCm - 5 * age - 161;
        }
        const tdee = bmr * activity;

        resultBox.style.display = 'block';
        resultBox.innerHTML =
            'BMI kamu: <span class="result-highlight">' + bmi.toFixed(1) + '</span> (' + kategori + ')' +
            '<br>Kebutuhan kalori harian (perkiraan): <span class="result-highlight">' + Math.round(tdee) + ' kkal</span>' +
            '<br><br><strong>Tips:</strong> Mengetahui kebutuhan kalori bisa membantu kamu mengatur porsi makan agar tidak berlebihan, ' +
            'sehingga makanan yang dibeli dan disajikan lebih sesuai dengan kebutuhan dan tidak banyak yang terbuang.';
    }

    // =======================
    // 2. CONFIG MODEL (TANPA API KEY)
    // =======================
    // Model ditentukan di front-end, API key disimpan di backend.
    const GEMINI_MODEL_TEXT = "gemini-2.5-flash";
    const GEMINI_MODEL_VISION = "gemini-2.5-flash";

    const chatBox = document.getElementById('chatBox');

    // =======================
    // 3. HISTORY AWAL CHAT
    // =======================
    const geminiHistory = [
        {
            role: "user",
            parts: [
                {
                    text:
                        "Kamu adalah asisten AI berbahasa Indonesia yang ahli mengelola sampah makanan, food waste, " +
                        "serta kaitannya dengan SDGs 2 (Zero Hunger) dan SDGs 12 (Responsible Consumption and Production). " +
                        "Jawabanmu singkat, jelas, dan praktis."
                }
            ]
        },
        {
            role: "model",
            parts: [
                { text: "Baik, saya siap membantu menjawab pertanyaan seputar sampah makanan dan SDGs." }
            ]
        }
    ];

    // =======================
    // 4. PANGGIL GEMINI TEKS VIA BACKEND
    // =======================
    async function panggilGemini(pesanUser) {
        geminiHistory.push({
            role: "user",
            parts: [{ text: pesanUser }]
        });

        const body = { contents: geminiHistory, model: GEMINI_MODEL_TEXT };

        const res = await fetch("/api/gemini-text", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        const data = await res.json();
        console.log("Respon chat dari backend:", data);

        if (data.error) {
            console.error("Error dari backend / Gemini:", data.error);
            throw new Error(data.error.message || "Error dari Gemini");
        }

        const jawab =
            data?.candidates?.[0]?.content?.parts?.[0]?.text ||
            "Maaf, AI tidak mengembalikan jawaban.";

        geminiHistory.push({
            role: "model",
            parts: [{ text: jawab }]
        });

        return jawab;
    }

    // =======================
    // 5. CHAT UI
    // =======================
    function tambahPesan(teks, dariUser) {
        const msg = document.createElement("div");
        msg.classList.add("chat-msg", dariUser ? "user" : "bot");

        const bubble = document.createElement("div");
        bubble.classList.add("chat-bubble");
        bubble.textContent = teks;

        msg.appendChild(bubble);
        chatBox.appendChild(msg);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    async function kirimPesanAI() {
        const input = document.getElementById("chatInput");
        const teks = input.value.trim();
        if (!teks) return;

        tambahPesan(teks, true);
        input.value = "";

        const loading = document.createElement("div");
        loading.classList.add("chat-msg", "bot");
        const bubble = document.createElement("div");
        bubble.classList.add("chat-bubble");
        bubble.textContent = "‚è≥ AI sedang memproses...";
        loading.appendChild(bubble);
        chatBox.appendChild(loading);
        chatBox.scrollTop = chatBox.scrollHeight;

        try {
            const jawaban = await panggilGemini(teks);
            loading.remove();
            tambahPesan(jawaban, false);
        } catch (e) {
            loading.remove();
            console.error(e);
            tambahPesan("‚ö†Ô∏è Terjadi kesalahan memanggil AI: " + (e.message || ""), false);
        }
    }

    // Pesan pembuka
    tambahPesan("Halo! Aku terhubung ke AI server. Tanyakan apa saja tentang sampah makanan, food waste, atau SDGs 2 & 12.", false);

    // =======================
    // 6. ‚ÄúSCANNER‚Äù MAKANAN & KALORI (MANUAL)
    // =======================
    const foodCaloriesPer100g = {
        "nasi": 130,
        "nasi putih": 130,
        "nasi goreng": 180,
        "ayam goreng": 260,
        "ayam bakar": 200,
        "sayur tumis": 80,
        "sayur bening": 40,
        "mie goreng": 190,
        "mie rebus": 150,
        "roti": 250,
        "tempe goreng": 190,
        "tahu goreng": 160
    };

    function deteksiJenisSampah(nama) {
        const lower = nama.toLowerCase();
        if (lower.includes('plastik') || lower.includes('bungkus') || lower.includes('styrofoam') || lower.includes('kaleng') || lower.includes('botol')) {
            return 'Anorganik (kemasan, tidak mudah terurai)';
        }
        if (lower.includes('tulang') || lower.includes('tulang ayam')) {
            return 'Organik (tulang, dapat diolah/busuk alami, bisa dibedakan dari sayur/nasi untuk pengolahan lanjut).';
        }
        return 'Organik (sisa makanan: nasi, lauk, sayur, buah, dsb.)';
    }

    function scanMakanan() {
        const nameInput = document.getElementById('foodName');
        const weightInput = document.getElementById('foodWeight');
        const resultBox = document.getElementById('scannerResult');

        const nama = nameInput.value.trim();
        const weight = parseFloat(weightInput.value);

        if (!nama || !weight || weight <= 0) {
            alert('Isi nama makanan dan berat yang benar ya.');
            return;
        }

        const lowerName = nama.toLowerCase();
        let kaloriPer100 = null;

        for (const key in foodCaloriesPer100g) {
            if (lowerName.includes(key)) {
                kaloriPer100 = foodCaloriesPer100g[key];
                break;
            }
        }

        let estimasiKaloriText;
        if (kaloriPer100) {
            const totalKalori = kaloriPer100 * (weight / 100);
            estimasiKaloriText = totalKalori.toFixed(0) + ' kkal (estimasi untuk ' + weight + ' g).';
        } else {
            estimasiKaloriText = "Data kalori makanan ini belum ada di database sederhana kami. Untuk tugas, kamu bisa tambahkan sendiri di variabel JavaScript.";
        }

        const jenisSampah = deteksiJenisSampah(nama);

        resultBox.style.display = 'block';
        resultBox.innerHTML =
            '<strong>Nama makanan:</strong> ' + nama +
            '<br><strong>Berat:</strong> ' + weight + ' g' +
            '<br><strong>Perkiraan jenis sampah:</strong> ' + jenisSampah +
            '<br><strong>Estimasi kalori:</strong> ' + estimasiKaloriText +
            '<br><br><em>Catatan:</em> Jika makanan seperti ini sering tersisa dan dibuang, coba atur ulang porsi atau pola belanja untuk mengurangi food waste.';
    }

    // =======================
    // 7. AI VISION ‚Äì ANALISIS FOTO MAKANAN VIA BACKEND
    // =======================
    async function panggilGeminiVision(base64Image, mimeType) {
        const body = {
            contents: [
                {
                    parts: [
                        {
                            text:
                                "Kamu diminta menganalisis foto makanan. " +
                                "Jawab dalam bahasa Indonesia, dengan struktur: " +
                                "1) Jelaskan makanan apa saja yang terlihat. " +
                                "2) Perkirakan total kalori secara kasar. " +
                                "3) Beri saran singkat untuk mengurangi food waste dari makanan ini."
                        },
                        {
                            inlineData: {
                                mimeType: mimeType,
                                data: base64Image
                            }
                        }
                    ]
                }
            ],
            model: GEMINI_MODEL_VISION
        };

        const res = await fetch("/api/gemini-vision", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body)
        });

        const data = await res.json();
        console.log("Respon vision dari backend:", data);

        if (data.error) {
            console.error("Error Vision:", data.error);
            throw new Error(data.error.message || "Gagal memanggil AI Vision");
        }

        const text =
            data?.candidates?.[0]?.content?.parts?.[0]?.text ||
            "Maaf, AI tidak mengembalikan jawaban.";

        return text;
    }

    async function handleVisionUpload() {
        const fileInput = document.getElementById("foodImage");
        const resultBox = document.getElementById("visionResult");
        const preview = document.getElementById("visionPreview");

        if (!fileInput.files || !fileInput.files[0]) {
            alert("Pilih foto dulu ya.");
            return;
        }

        const file = fileInput.files[0];

        // Preview
        const previewUrl = URL.createObjectURL(file);
        preview.src = previewUrl;
        preview.style.display = "block";

        resultBox.style.display = "block";
        resultBox.innerHTML = "‚è≥ Mengirim gambar ke AI, tunggu sebentar...";

        const reader = new FileReader();
        reader.onload = async () => {
            try {
                const base64 = reader.result.split(",")[1];
                const jawaban = await panggilGeminiVision(base64, file.type);

                resultBox.innerHTML =
                    "<strong>Hasil analisis AI:</strong><br>" +
                    jawaban.replace(/\n/g, "<br>");
            } catch (err) {
                console.error(err);
                resultBox.innerHTML = "‚ö†Ô∏è Terjadi kesalahan saat memanggil AI Vision: " + (err.message || "");
            }
        };

        reader.readAsDataURL(file);
    }

    // =======================
    // 8. CATATAN (UNTUK PENJELASAN TUGAS)
    // =======================
    /*
      Di versi ini:
      - Front-end (file HTML ini) TIDAK menyimpan API key.
      - Semua request AI (chat & vision) dikirim ke endpoint backend:
          /api/gemini-text
          /api/gemini-vision
      - Backend yang akan memanggil Gemini API dengan API key rahasia yang disimpan
        sebagai environment variable (GEMINI_API_KEY) di server / Vercel.

      Ini adalah cara "aman" untuk mem-publish website yang memakai API berbayar
      seperti Gemini tanpa membocorkan API key ke publik.
    */
</script>

</body>
</html>
